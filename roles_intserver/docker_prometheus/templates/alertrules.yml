
{% raw %}

groups:


- name: system

  rules:

  - alert: SCRAPE_FAIL
    expr: up < 1
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "Metric Scape is failing for {{ $labels.job }}"

  - alert: SYS_DOWN
    expr: system_uptime < 1
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "System {{ $labels.job }} is down"

- name: memory

  rules:

  - alert: MEM_FULL
    expr: (( mem_total - mem_free ) / mem_total * 100) > 90
    for: 15m
    annotations:
      summary: "Memory HIGH on {{ $labels.job }} / mem_free = {{ $value }}"


- name: cpu

  rules:

  - alert: HIGH_CPU
    expr: cpu_usage_idle < 0.1 
    for: 15m
    annotations:
      summary: "CPU HIGH on {{ $labels.job }} / usage_idle = {{ $value }}"


- name: disk

  rules:

  - alert: HIGH_DISK_IO
    expr: diskio_iops_in_progress > 10 
    for: 5m
    annotations:
      summary: "Memory HIGH on {{ $labels.job }} / diskio_iops_in_progress = {{ $value }}"

  - alert: DISK_FULL_85P 
    expr: ( 100 * ( 1 - ( disk_free / disk_total ) ) ) > 85
    annotations:
      summary: "Disk FULL_85% on {{ $labels.job }} / {{ $labels.path }} / full = {{ $value }}"
      
  - alert: DISK_FULL_95P 
    expr: ( 100 * ( 1 - ( disk_free / disk_total ) ) ) > 95 
    labels:
      severity: high 
    annotations:
      summary: "Disk FULL_95% on {{ $labels.job }} / {{ $labels.path }} / full = {{ $value }}"
      
  - alert: DISK_FULL_IN_24H
    expr: predict_linear( disk_free[24h], 24*3600 ) < 0
    annotations:
      summary: "Disk {{ $labels.job }} / {{ $labels.path }} will be full in 24 hours"

  - alert: DISK_FULL_IN_4H
    expr: predict_linear( disk_free[4h], 4*3600 ) < 0
    labels:
      severity: high 
    annotations:
      summary: "Disk {{ $labels.job }} / {{ $labels.path }} will be full in 4 hours"


- name: rsyncbackup

  rules:

  - alert: RSYNC_BACKUP_AGE
    expr: (time()-rsyncbackup_lastbackup)/60/60 > 2
    annotations:
      summary: "RSync Backup {{ $labels.job }} / {{ $labels.repo }} older than 2h"

  - alert: RSYNC_BACKUP_AGE_HIGH
    expr: (time()-rsyncbackup_lastbackup)/60/60 > 4
    labels:
      severity: high 
    annotations:
      summary: "RSync Backup {{ $labels.job }} / {{ $labels.repo }} older than 4h"


- name: borgbackup

  rules:

  - alert: BORG_BACKUP_AGE
    expr: (time()-borgbackup_lastbackup)/60/60 > 6
    annotations:
      summary: "Borg Backup {{ $labels.job }} / {{ $labels.repo }} older than 6h"

  - alert: BORG_BACKUP_AGE_HIGH
    expr: (time()-borgbackup_lastbackup)/60/60 > 12
    labels:
      severity: high 
    annotations:
      summary: "Borg Backup {{ $labels.job }} / {{ $labels.repo }} older than 12h"


- name: docker_running_containers

  rules:

  - alert: DOCKER_RUNNING_CONTAINERS_CONTROL
    expr: engine_daemon_container_states_containers{state="running",job="control_docker"} != 3
    annotations:
      summary: "Invalid number of containes on control / {{ $value }}"

  - alert: DOCKER_RUNNING_CONTAINERS_INTSERVER
    expr: engine_daemon_container_states_containers{state="running",job="intserver_docker"} != 8
    annotations:
      summary: "Invalid number of containes on intserver / {{ $value }}"

  - alert: DOCKER_RUNNING_CONTAINERS_MASTER
    expr: engine_daemon_container_states_containers{state="running",job="master_docker"} != 1
    annotations:
      summary: "Invalid number of containes on master / {{ $value }}"

  - alert: DOCKER_RUNNING_CONTAINERS_WEBSERVER1
    expr: engine_daemon_container_states_containers{state="running",job="webserver1_docker"} != 10
    annotations:
      summary: "Invalid number of containes on webserver1 / {{ $value }}"

  - alert: DOCKER_RUNNING_CONTAINERS_WEBSERVER2
    expr: engine_daemon_container_states_containers{state="running",job="webserver2_docker"} != 15
    annotations:
      summary: "Invalid number of containes on webserver2 / {{ $value }}"


- name: ldap

  rules:

  - alert: LDAP_DOWN
    expr: openldap_up < 1
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP {{ $labels.job }} is down"


  - alert: LDAP_UNSYNC_ENTRIES_WS1_WS2
    expr: openldap_entries_num{job="webserver1_ldap"} != ignoring(job) openldap_entries_num{job="webserver2_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_ENTRIES_WS1_WS2"
      
  - alert: LDAP_UNSYNC_ENTRIES_WS1_INT
    expr: openldap_entries_num{job="webserver1_ldap"} != ignoring(job) openldap_entries_num{job="intserver_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_ENTRIES_WS1_INT"

  - alert: LDAP_UNSYNC_ENTRIES_WS2_INT
    expr: openldap_entries_num{job="webserver2_ldap"} != ignoring(job) openldap_entries_num{job="intserver_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_ENTRIES_WS2_INT"


  - alert: LDAP_UNSYNC_CSN000_WS1_WS2
    expr: openldap_contextCSN{index="000",job="webserver1_ldap"} != ignoring(job) openldap_contextCSN{index="000",job="webserver2_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_CSN000_WS1_WS2"
      
  - alert: LDAP_UNSYNC_000_WS1_INT
    expr: openldap_contextCSN{index="000",job="webserver1_ldap"} != ignoring(job) openldap_contextCSN{index="000",job="intserver_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNCCSN_000_WS1_INT"

  - alert: LDAP_UNSYNC_CSN000_WS2_INT
    expr: openldap_contextCSN{index="000",job="webserver2_ldap"} != ignoring(job) openldap_contextCSN{index="000",job="intserver_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_CSN000_WS2_INT"


  - alert: LDAP_UNSYNC_CSN001_WS1_WS2
    expr: openldap_contextCSN{index="001",job="webserver1_ldap"} != ignoring(job) openldap_contextCSN{index="001",job="webserver2_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_CSN001_WS1_WS2"
      
  - alert: LDAP_UNSYNC_CSN001_WS1_INT
    expr: openldap_contextCSN{index="001",job="webserver1_ldap"} != ignoring(job) openldap_contextCSN{index="001",job="intserver_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_CSN001_WS1_INT"

  - alert: LDAP_UNSYNC_CSN001_WS2_INT
    expr: openldap_contextCSN{index="001",job="webserver2_ldap"} != ignoring(job) openldap_contextCSN{index="001",job="intserver_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_CSN001_WS2_INT"

  - alert: LDAP_UNSYNC_CSN002_WS1_WS2
    expr: openldap_contextCSN{index="002",job="webserver1_ldap"} != ignoring(job) openldap_contextCSN{index="002",job="webserver2_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_CSN002_WS1_WS2"
      
  - alert: LDAP_UNSYNC_CSN002_WS1_INT
    expr: openldap_contextCSN{index="002",job="webserver1_ldap"} != ignoring(job) openldap_contextCSN{index="002",job="intserver_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_002_WS1_INT"

  - alert: LDAP_UNSYNC_CSN002_WS2_INT
    expr: openldap_contextCSN{index="002",job="webserver2_ldap"} != ignoring(job) openldap_contextCSN{index="002",job="intserver_ldap"}
    for: 1m
    labels:
      severity: high 
    annotations:
      summary: "LDAP_UNSYNC_CSN002_WS2_INT"

{% endraw %}
